<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <link rel="icon" href="https://files.catbox.moe/w6l8pf.jpg">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DFS TECH TUBE</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
body { 
  margin:0; 
  font-family:Segoe UI,sans-serif; 
  color:#fff;
  background: url('https://files.catbox.moe/w6l8pf.jpg') no-repeat center center fixed;
  background-size: cover;
}

body::before {
  content:"";
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.75);
  z-index:-1;
}

header {
  padding:10px;
  background:rgba(17,17,17,0.9);
  display:flex;
  gap:10px;
  align-items:center;
}

.site-name {
  font-weight:bold;
  font-size:18px;
  color:#B00000;
  white-space:nowrap;
}

video { width:100%; max-height:260px; background:#000; }

.actions {
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  border-bottom:1px solid #222;
  background:rgba(0,0,0,0.8);
}

.action-btn {
  background:none;
  border:none;
  color:white;
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:14px;
}

.action-btn i {
  font-size:18px;
  margin-bottom:2px;
}

.info { padding:10px; background:rgba(0,0,0,0.8); }

.list-area {
  padding:10px;
  border-top:1px solid #222;
  background:rgba(0,0,0,0.85);
}

.video-item {
  display:flex;
  gap:10px;
  margin-bottom:10px;
  cursor:pointer;
}

.video-item img {
  width:120px;
  border-radius:6px;
}

/* ===== MENSAGEM PERSONALIZADA ===== */
#msgBox {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  border-radius:10px;
  display:none;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  box-shadow:0 0 10px #000;
  z-index:9999;
}

#msgBox img {
  width:50px;
  border-radius:6px;
}

#msgBox span {
  color:white;
  font-size:14px;
}
</style>
<link rel="stylesheet" href="/assets/css/dfs-standard.css">
</head>

<body>
<canvas id="dfs-bg-canvas" aria-hidden="true"></canvas>

<header>
  <div class="site-name">DFS TECH TUBE</div>
  <input id="searchInput" class="form-control" placeholder="Pesquisar vídeo...">
  <button class="btn btn-danger" onclick="searchVideo()">
    <i class="fas fa-search"></i>
  </button>
</header>

<div id="playerArea"></div>

<div class="list-area">
  <h5><i class="fas fa-chart-line"></i> Mais vistos por você</h5>
  <div id="historyList"></div>
</div>

<!-- CAIXA DE MENSAGEM -->
<div id="msgBox">
  <img src="https://files.catbox.moe/w6l8pf.jpg">
  <span id="msgText"></span>
</div>

<script>
const API = window.location.origin;

let currentVideoUrl = "";
let statsInterval = null;

/* ===== FUNÇÃO DE MENSAGEM ===== */
function showMessage(text){
  const box = document.getElementById("msgBox");
  const msg = document.getElementById("msgText");
  msg.innerText = text;
  box.style.display = "flex";

  setTimeout(()=>{
    box.style.display = "none";
  },3000);
}

// ================= BUSCA =================
async function searchVideo(){
  const q = searchInput.value.trim();
  if(!q) return showMessage("Digite algo");

  const res = await fetch(`${API}/api/public/youtube/search?nome=${encodeURIComponent(q)}`);
  const data = await res.json();
  const list = Array.isArray(data?.resultado) ? data.resultado : [];
  const v = list.find(item => item?.type === "video") || list.find(item => item?.url) || null;
  if(!v) return showMessage("Nenhum vídeo encontrado");

  playVideo(v);
}

// ================= PLAYER =================
function playVideo(v){
  const sourceQuery = v.url || v.title || "";
  const apiVideoUrl = `${API}/api/public/youtube/video?nome=${encodeURIComponent(sourceQuery)}`;
  currentVideoUrl = v.url;

  saveHistory(v);
  renderPlayer(v.title, apiVideoUrl, v.url, sourceQuery);

  if(statsInterval) clearInterval(statsInterval);
  updateStats();
  statsInterval = setInterval(updateStats, 5000);

  renderHistory();
}

function renderPlayer(title, apiUrl, originalUrl, sourceQuery){
  const downloadUrl = `${API}/api/public/youtube/download?nome=${encodeURIComponent(sourceQuery || originalUrl || title || "")}`;
  const downloadMp3Url = `${API}/api/public/youtube/download-mp3?nome=${encodeURIComponent(sourceQuery || originalUrl || title || "")}`;
  playerArea.innerHTML = `
    <video controls autoplay>
      <source src="${apiUrl}" type="video/mp4">
    </video>

    <div class="info">
      <div><b>${title}</b></div>
      <div class="text-secondary">
        <span id="viewCount">0</span> visualizações
      </div>
    </div>

    <div class="actions">
      <button class="action-btn" onclick="like(this)">
        <i class="fas fa-thumbs-up"></i>
        <span id="likeCount">0</span>
      </button>

      <button class="action-btn" onclick="share('${originalUrl}')">
        <i class="fas fa-share"></i>
        Compartilhar
      </button>

      <button class="action-btn" onclick="saveVideo('${downloadUrl}', '${sanitize(title)}.mp4')">
        <i class="fas fa-download"></i>
        BAIXAR MP4
      </button>

      <button class="action-btn" onclick="saveVideo('${downloadMp3Url}', '${sanitize(title)}.mp3')">
        <i class="fas fa-music"></i>
        BAIXAR MP3
      </button>
    </div>
  `;
}

// ================= STATS =================
async function updateStats(){
  if(!currentVideoUrl) return;

  const r = await fetch(`${API}/api/public/youtube/search?nome=${encodeURIComponent(currentVideoUrl)}`);
  const data = await r.json();
  const list = Array.isArray(data?.resultado) ? data.resultado : [];
  const v = list.find(item => item?.type === "video") || list.find(item => item?.url) || null;
  if (!v) return;

  document.getElementById("viewCount").innerText = v.views || 0;
  document.getElementById("likeCount").innerText = v.likes || 0;
}

// ================= HISTÓRICO =================
function saveHistory(v){
  let history = JSON.parse(localStorage.getItem("history")) || {};

  if(!history[v.url]){
    history[v.url] = {
      title: v.title,
      thumb: v.thumbnail,
      url: v.url,
      count: 1
    };
  } else {
    history[v.url].count++;
  }

  localStorage.setItem("history", JSON.stringify(history));
}

function renderHistory(){
  const list = document.getElementById("historyList");
  let history = JSON.parse(localStorage.getItem("history")) || {};

  let arr = Object.values(history);
  arr.sort((a,b)=>b.count - a.count);

  list.innerHTML = "";

  arr.forEach(v=>{
    list.innerHTML += `
      <div class="video-item" onclick="playFromHistory('${v.url}')">
        <img src="${v.thumb}">
        <div>
          <b>${v.title}</b><br>
          <i class="fas fa-eye"></i> ${v.count} vezes
        </div>
      </div>
    `;
  });
}

async function playFromHistory(url){
  const res = await fetch(`${API}/api/public/youtube/search?nome=${encodeURIComponent(url)}`);
  const data = await res.json();
  const list = Array.isArray(data?.resultado) ? data.resultado : [];
  const v = list.find(item => item?.type === "video") || list.find(item => item?.url) || null;
  if (!v) return showMessage("Vídeo não encontrado no histórico");
  playVideo(v);
}

// ================= BOTÕES =================
function like(btn){
  btn.style.color="#B00000";
}

function share(originalUrl){
  if(navigator.share){
    navigator.share({ title:"DFS TECH TUBE", url: originalUrl });
  } else {
    navigator.clipboard.writeText(originalUrl);
    showMessage("Link copiado!");
  }
}

function saveVideo(url, filename){
  if (!url) return showMessage("Link de vídeo inválido");
  const a = document.createElement("a");
  a.href = url;
  a.download = filename || "video.mp4";
  a.rel = "noopener";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showMessage("Download iniciado");
}

function sanitize(text){
  return String(text || "").replace(/[\\/:*?"<>|']/g,"");
}

// ================= INIT =================
renderHistory();
</script>

<script src="/assets/js/dfs-standard.js"></script>
</body>
</html>
